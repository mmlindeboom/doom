#+title: Doom Emacs Config
#+author: Matt Lindeboom
#+email: matt@b0om.net
#+property: header-args :tangle yes
#+auto_tangle: t

* Bootstrap
** Workarounds
#+begin_src emacs-lisp
;; Workaround for missing transient error: https://github.com/doomemacs/doomemacs/issues/8541
(let ((lfile (concat doom-local-dir "straight/repos/transient/lisp/transient.el")))
  (if (file-exists-p lfile)
      (load lfile)))
#+end_src

** Personal Information
#+begin_src emacs-lisp
(setq user-full-name "Matt Lindeboom"
      user-mail-address "matt@b0om.net")
#+end_src

* Appearance
** Fonts & Theme
#+begin_src emacs-lisp
(setq doom-font (font-spec :family "Dank Mono" :size 16)
      doom-variable-pitch-font (font-spec :family "Vollkorn" :size 18)
      doom-serif-font (font-spec :family "Vollkorn")
      doom-theme 'doom-leuven
      display-line-numbers-type t)

(use-package mixed-pitch
  :hook (text-mode . mixed-pitch-mode)
  :config
  (set-face-attribute 'default nil :font "Dank Mono" :height 150)
  (set-face-attribute 'fixed-pitch nil :font "Dank Mono")
  (set-face-attribute 'variable-pitch nil :font "Vollkorn"))
(add-hook 'mixed-pitch-mode-hook #'solaire-mode-reset)
#+end_src

** Icons
#+begin_src emacs-lisp
(require 'all-the-icons)
(use-package! nerd-icons)
#+end_src

** Modeline
#+begin_src emacs-lisp
(doom-modeline-mode 1)
(setq doom-modeline-icon t)
(setq doom-modeline-major-mode-color-icon t)

(set-face-background 'mode-line "#8c1eff")
(set-face-background 'mode-line-inactive "#bfb5c9")
(set-face-attribute 'mode-line nil :font "FantasqueSansM Nerd Font Mono")
(set-face-attribute 'mode-line-inactive nil :font "FantasqueSansM Nerd Font Mono")
#+end_src

** Dashboard & Frame
#+begin_src emacs-lisp
(when window-system
  (remove-hook '+doom-dashboard-functions #'doom-dashboard-widget-shortmenu)
  (add-hook! '+doom-dashboard-functions :append
    (defun my-dashboard-widget ()
      (insert "\n\n")))
  (setq-hook! '+doom-dashboard-mode-hook evil-normal-state-cursor (list nil))
  (setq fancy-splash-image (concat doom-user-dir "biggreenbuddha-614.png"))
  (setq-default line-spacing 0.24)
  (modify-all-frames-parameters
   '((right-divider-width . 10)
     (internal-border-width . 10)))
  (dolist (face '(window-divider
                  window-divider-first-pixel
                  window-divider-last-pixel))
    (face-spec-reset-face face)
    (set-face-foreground face (face-attribute 'default :background)))
  (set-face-background 'fringe (face-attribute 'default :background)))

;; Force dashboard on startup
(setq initial-buffer-choice (lambda () (get-buffer-create "*doom*")))
#+end_src

* Completion & Search
Note: Vertico is enabled in init.el. Ivy/Counsel below provides additional search commands.

#+begin_src emacs-lisp
(use-package counsel
  :after ivy
  :config (counsel-mode))

(use-package ivy
  :custom
  (setq ivy-use-virtual-buffers t)
  (setq ivy-count-format "(%d/%d) ")
  (setq enable-recursive-minibuffers t)
  :config
  (ivy-mode))

(global-set-key (kbd "C-s") 'swiper-isearch)
(map! :leader
      :desc "Open Swiper" "sw" #'swiper
      :desc "Open Counsel-rg" "sc" #'counsel-rg)
#+end_src

* Workspaces & Navigation
** Perspective
The Perspective package provides multiple named workspaces (or "perspectives") in Emacs,
similar to multiple desktops in window managers. Each perspective has its own buffer list
and window layout.

#+begin_src emacs-lisp
(use-package perspective
  :bind
  ("C-x C-b" . persp-list-buffers)
  :config
  (persp-mode))

(after! persp-mode
  (setq persp-auto-save-opt 1
        persp-auto-resume-time 1
        persp-autokill-buffer-on-remove 'kill-weak
        persp-save-dir (expand-file-name "workspaces/" doom-local-dir)))

(map! :leader
      :desc "Switch to perspective NAME"       "DEL" #'persp-switch
      :desc "Create new perspective with NAME" "p"   #'persp-add-new
      :desc "Switch to buffer in perspective"  ","   #'persp-switch-to-buffer
      :desc "Switch to next perspective"       "]"   #'persp-next
      :desc "Switch to previous perspective"   "["   #'persp-prev
      :desc "Add a buffer current perspective" "+"   #'persp-add-buffer
      :desc "Remove perspective by name"       "-"   #'persp-remove-by-name
      :desc "Save state to file"               "s f" #'persp-save-state-to-file)
#+end_src

** Projectile
#+begin_src emacs-lisp
(use-package projectile
  :config
  (projectile-global-mode 1))
#+end_src

* Org Mode
** Core Settings
#+begin_src emacs-lisp
(setq org-directory "~/org/")
#+end_src

** org-appear
#+begin_src emacs-lisp
(use-package org-appear
  :hook (org-mode . org-appear-mode))
#+end_src

** org-modern
#+begin_src emacs-lisp
(use-package! org-modern
  :hook (org-mode . org-modern-mode)
  :config
  (setq org-modern-star '("◉" "○" "◈" "◇" "✳")
        org-modern-checkbox '((?X . "☑") (?- . "◧") (?\s . "☐"))))
#+end_src

** org-auto-tangle
#+begin_src emacs-lisp
(use-package! org-auto-tangle
  :defer t
  :hook (org-mode . org-auto-tangle-mode)
  :config
  (setq org-auto-tangle-default t))

(defun dt/insert-auto-tangle-tag ()
  "Insert auto-tangle tag in a literate config."
  (interactive)
  (evil-org-open-below 1)
  (insert "#+auto_tangle: t ")
  (evil-force-normal-state))

(map! :leader
      :desc "Insert auto_tangle tag" "i a" #'dt/insert-auto-tangle-tag)
#+end_src

* Terminal
** VTerm & Multi-Vterm
#+begin_src emacs-lisp
(map! :leader
      :desc "Vterm popup toggle" "v t" #'+vterm/toggle
      :desc "Multi vterm create" "v m" #'multi-vterm
      :desc "Multi vterm next"   "v ]" #'multi-vterm-next)

(use-package multi-vterm
  :config
  (add-hook 'vterm-mode-hook
            (lambda ()
              (setq evil-insert-state-cursor 'box)
              (evil-insert-state)))
  (define-key vterm-mode-map [return] #'vterm-send-return)

  (setq vterm-keymap-exceptions nil)
  (evil-define-key 'insert vterm-mode-map (kbd "C-e")      #'vterm--self-insert)
  (evil-define-key 'insert vterm-mode-map (kbd "C-f")      #'vterm--self-insert)
  (evil-define-key 'insert vterm-mode-map (kbd "C-a")      #'vterm--self-insert)
  (evil-define-key 'insert vterm-mode-map (kbd "C-v")      #'vterm--self-insert)
  (evil-define-key 'insert vterm-mode-map (kbd "C-b")      #'vterm--self-insert)
  (evil-define-key 'insert vterm-mode-map (kbd "C-w")      #'vterm--self-insert)
  (evil-define-key 'insert vterm-mode-map (kbd "C-u")      #'vterm--self-insert)
  (evil-define-key 'insert vterm-mode-map (kbd "C-d")      #'vterm--self-insert)
  (evil-define-key 'insert vterm-mode-map (kbd "C-n")      #'vterm--self-insert)
  (evil-define-key 'insert vterm-mode-map (kbd "C-m")      #'vterm--self-insert)
  (evil-define-key 'insert vterm-mode-map (kbd "C-p")      #'vterm--self-insert)
  (evil-define-key 'insert vterm-mode-map (kbd "C-j")      #'vterm--self-insert)
  (evil-define-key 'insert vterm-mode-map (kbd "C-k")      #'vterm--self-insert)
  (evil-define-key 'insert vterm-mode-map (kbd "C-r")      #'vterm--self-insert)
  (evil-define-key 'insert vterm-mode-map (kbd "C-t")      #'vterm--self-insert)
  (evil-define-key 'insert vterm-mode-map (kbd "C-g")      #'vterm--self-insert)
  (evil-define-key 'insert vterm-mode-map (kbd "C-c")      #'vterm--self-insert)
  (evil-define-key 'insert vterm-mode-map (kbd "C-SPC")    #'vterm--self-insert)
  (evil-define-key 'normal vterm-mode-map (kbd "C-d")      #'vterm--self-insert)
  (evil-define-key 'normal vterm-mode-map (kbd ",c")       #'multi-vterm)
  (evil-define-key 'normal vterm-mode-map (kbd ",n")       #'multi-vterm-next)
  (evil-define-key 'normal vterm-mode-map (kbd ",p")       #'multi-vterm-prev)
  (evil-define-key 'normal vterm-mode-map (kbd "i")        #'evil-insert-resume)
  (evil-define-key 'normal vterm-mode-map (kbd "o")        #'evil-insert-resume)
  (evil-define-key 'normal vterm-mode-map (kbd "<return>") #'evil-insert-resume))
#+end_src

* Programming
** LSP (Eglot)
#+begin_src emacs-lisp
(use-package! eglot
  :config
  (add-to-list 'eglot-server-programs
               '(python-mode . ("pyright-langserver" "--stdio"))
               '(typescript-mode . ("typescript-language-server"))))
#+end_src

** Python
#+begin_src emacs-lisp
(use-package python-black
  :demand t
  :after python
  :hook (python-mode . python-black-on-save-mode))

(setq tab-width 4)
#+end_src

* Email
** Notmuch
Notmuch provides fast, tag-based email with excellent search capabilities.

#+begin_src emacs-lisp
(after! notmuch
  (setq user-full-name "Matt Lindeboom"
        user-mail-address "matt@b0om.net")

  (setq notmuch-show-logo nil
        notmuch-hello-thousands-separator ","
        notmuch-hello-sections
        '(notmuch-hello-insert-saved-searches
          notmuch-hello-insert-search
          notmuch-hello-insert-recent-searches
          notmuch-hello-insert-alltags))

  (setq notmuch-saved-searches
        '((:name "inbox"    :query "tag:inbox"   :key "i")
          (:name "unread"   :query "tag:unread"  :key "u")
          (:name "flagged"  :query "tag:flagged" :key "f")
          (:name "sent"     :query "tag:sent"    :key "t")
          (:name "drafts"   :query "tag:draft"   :key "d")
          (:name "all mail" :query "*"           :key "a")))

  (setq message-send-mail-function 'message-send-mail-with-sendmail
        sendmail-program "/usr/local/bin/msmtp"
        message-sendmail-extra-arguments '("--read-envelope-from")
        message-sendmail-f-is-evil t)

  (setq notmuch-archive-tags '("-inbox" "+archived")))

(setq +notmuch-sync-backend 'mbsync)

(map! :leader
      (:prefix-map ("o m" . "mail")
       :desc "Open notmuch"  "m" #'notmuch
       :desc "Compose email" "c" #'notmuch-mua-new-mail
       :desc "Search email"  "s" #'notmuch-search
       :desc "Sync email"    "S" #'+notmuch/update))
#+end_src

* AI Tools
** Claude Code
#+begin_src emacs-lisp
(use-package claude-code :ensure t
  :vc (:url "https://github.com/stevemolitor/claude-code.el" :rev :newest)
  :config (claude-code-mode))
#+end_src
